<!DOCTYPE html>
<html>
<head>
    <title>ČSFD Rating Overlay</title>
</head>
<body>
    <div id="CsfdRatingOverlayConfigPage" data-role="page" class="page type-interior pluginConfigurationPage">
        <div data-role="content">
            <div class="content-primary">
                <form id="CsfdRatingOverlayConfigForm">
                    <div class="verticalSection">
                        <div class="sectionTitleContainer flex align-items-center">
                            <h2 class="sectionTitle">ČSFD Rating Overlay</h2>
                        </div>
                        <p>Configure ČSFD fetching, retries, cache actions, and optional web overlay injection.</p>
                        
                        <div class="inputContainer">
                            <label class="emby-checkbox-label">
                                <input is="emby-checkbox" type="checkbox" id="chkEnabled" />
                                <span>Enable plugin</span>
                            </label>
                        </div>

                        <div class="inputContainer">
                            <label class="emby-checkbox-label">
                                <input is="emby-checkbox" type="checkbox" id="chkOverlayInjectionEnabled" />
                                <span>Enable web overlay injection</span>
                            </label>
                            <div class="fieldDescription">Injects a script into the web interface to display rating badges on posters.</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="txtRequestDelayMs">Request delay (ms)</label>
                            <input is="emby-input" type="number" id="txtRequestDelayMs" min="500" step="100" required />
                            <div class="fieldDescription">Time to wait between requests to ČSFD to avoid rate limiting.</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="txtMaxRetries">Max retries</label>
                            <input is="emby-input" type="number" id="txtMaxRetries" min="1" step="1" required />
                            <div class="fieldDescription">Maximum number of retries for transient errors.</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="txtCooldownMinMinutes">Cooldown minimum (minutes)</label>
                            <input is="emby-input" type="number" id="txtCooldownMinMinutes" min="1" step="1" required />
                            <div class="fieldDescription">Minimum time to wait before retrying a failed item.</div>
                        </div>

                        <div>
                            <button is="emby-button" type="submit" class="raised button-submit block">
                                <span>Save</span>
                            </button>
                        </div>
                    </div>
                </form>
                
                <div class="verticalSection">
                    <h3 class="sectionTitle">Status</h3>
                    <div style="background: rgba(0,0,0,0.2); padding: 1em; border-radius: 4px; margin-bottom: 1em;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5em;">
                            <span>Queue Size:</span>
                            <span id="statQueueSize" style="font-weight: bold;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5em;">
                            <span>Total Library Items:</span>
                            <span id="statLibraryTotal" style="font-weight: bold;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5em;">
                            <span>Total Cached:</span>
                            <span id="statTotal" style="font-weight: bold;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5em;">
                            <span>Resolved:</span>
                            <span id="statResolved" style="font-weight: bold; color: #4caf50;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5em;">
                            <span>Not Found:</span>
                            <span id="statNotFound" style="font-weight: bold; color: #ff9800;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Errors:</span>
                            <span id="statErrors" style="font-weight: bold; color: #f44336;">-</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1em;">
                        <button is="emby-button" type="button" class="raised" id="btnRefreshStatus">
                            <span>Refresh Status</span>
                        </button>
                        <button is="emby-button" type="button" class="raised" id="btnPauseResume">
                            <span>Pause Processing</span>
                        </button>
                    </div>
                </div>

                <div class="verticalSection">
                    <h3 class="sectionTitle">Maintenance</h3>
                    <div style="display: flex; gap: 1em; flex-wrap: wrap;">
                        <button is="emby-button" type="button" class="raised" id="btnBackfill">
                            <span>Backfill Library</span>
                        </button>
                        <button is="emby-button" type="button" class="raised" id="btnRetryNotFound">
                            <span>Retry Unmatched</span>
                        </button>
                        <button is="emby-button" type="button" class="raised" id="btnRetryErrors">
                            <span>Retry Errors</span>
                        </button>
                        <button is="emby-button" type="button" class="raised" id="btnResetCache">
                            <span>Reset Cache</span>
                        </button>
                        <button is="emby-button" type="button" class="raised" id="btnInvalidateClientCache">
                            <span>Invalidate Client Cache</span>
                        </button>
                    </div>
                </div>

                <div class="verticalSection">
                    <h3 class="sectionTitle">Manual Matching</h3>
                    <p>List items that failed to match or were not found, and manually search for them on ČSFD.</p>
                    <button is="emby-button" type="button" class="raised" id="btnLoadUnmatched">
                        <span>Load Unmatched Items</span>
                    </button>
                    <div id="unmatchedList" style="margin-top: 1em;"></div>
                    
                    <div id="matchDialog" style="display: none; background: rgba(0,0,0,0.2); padding: 1em; margin-top: 1em; border-radius: 4px;">
                        <h4>Match Item: <span id="matchItemTitle"></span></h4>
                        <div class="inputContainer">
                            <input is="emby-input" type="text" id="txtMatchSearch" placeholder="Search query..." />
                        </div>
                        <button is="emby-button" type="button" class="raised" id="btnMatchSearch">
                            <span>Search</span>
                        </button>
                        <button is="emby-button" type="button" class="raised" id="btnMatchCancel">
                            <span>Cancel</span>
                        </button>
                        <div id="matchSearchResults" style="margin-top: 1em;"></div>
                    </div>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            var CsfdRatingOverlayConfig = {
                pluginId: 'b9643a4b-5b92-4f09-94c4-45ce6bfc57e9',
                currentMatchItemId: null,

                loadConfiguration: function () {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(CsfdRatingOverlayConfig.pluginId).then(function (config) {
                        document.querySelector('#chkEnabled').checked = config.Enabled;
                        document.querySelector('#chkOverlayInjectionEnabled').checked = config.OverlayInjectionEnabled;
                        document.querySelector('#txtRequestDelayMs').value = config.RequestDelayMs;
                        document.querySelector('#txtMaxRetries').value = config.MaxRetries;
                        document.querySelector('#txtCooldownMinMinutes').value = config.CooldownMinMinutes;
                        Dashboard.hideLoadingMsg();
                    });
                },

                saveConfiguration: function () {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(CsfdRatingOverlayConfig.pluginId).then(function (config) {
                        config.Enabled = document.querySelector('#chkEnabled').checked;
                        config.OverlayInjectionEnabled = document.querySelector('#chkOverlayInjectionEnabled').checked;
                        config.RequestDelayMs = parseInt(document.querySelector('#txtRequestDelayMs').value, 10);
                        config.MaxRetries = parseInt(document.querySelector('#txtMaxRetries').value, 10);
                        config.CooldownMinMinutes = parseInt(document.querySelector('#txtCooldownMinMinutes').value, 10);

                        ApiClient.updatePluginConfiguration(CsfdRatingOverlayConfig.pluginId, config).then(function (result) {
                            Dashboard.processPluginConfigurationUpdateResult(result);
                        });
                    });
                },
                
                runAction: function (action) {
                    Dashboard.showLoadingMsg();
                    ApiClient.ajax({
                        type: 'POST',
                        url: ApiClient.getUrl('Plugins/CsfdRatingOverlay/csfd/actions/' + action)
                    }).then(function () {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Action completed.');
                        CsfdRatingOverlayConfig.loadStatus();
                    }, function () {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Action failed.');
                    });
                },

                loadStatus: function () {
                    ApiClient.getJSON(ApiClient.getUrl('Plugins/CsfdRatingOverlay/csfd/status')).then(function (status) {
                        document.querySelector('#statQueueSize').textContent = status.QueueSize;
                        document.querySelector('#statLibraryTotal').textContent = status.TotalLibraryItems;
                        document.querySelector('#statTotal').textContent = status.CacheStats.TotalEntries;
                        document.querySelector('#statResolved').textContent = status.CacheStats.Resolved;
                        document.querySelector('#statNotFound').textContent = status.CacheStats.NotFound;
                        document.querySelector('#statErrors').textContent = status.CacheStats.Errors;
                        
                        var btnPause = document.querySelector('#btnPauseResume');
                        if (status.IsPaused) {
                            btnPause.textContent = "Resume Processing";
                            btnPause.setAttribute('data-action', 'resume');
                        } else {
                            btnPause.textContent = "Pause Processing";
                            btnPause.setAttribute('data-action', 'pause');
                        }
                    });
                },

                loadUnmatched: function() {
                    Dashboard.showLoadingMsg();
                    ApiClient.getJSON(ApiClient.getUrl('Plugins/CsfdRatingOverlay/csfd/unmatched')).then(function (items) {
                        Dashboard.hideLoadingMsg();
                        var html = '<div class="paperList">';
                        if (items.length === 0) {
                            html += '<div class="listItem">No unmatched items found.</div>';
                        } else {
                            items.forEach(function(item) {
                                html += '<div class="listItem" style="display: flex; align-items: center; justify-content: space-between; padding: 0.5em;">';
                                html += '<div style="flex-grow: 1;">';
                                html += '<div class="listItemBodyText" style="font-weight: bold;">' + (item.Title || 'Unknown') + ' (' + (item.Year || '?') + ')</div>';
                                html += '<div class="listItemBodyText secondary">' + item.Status + (item.LastError ? ': ' + item.LastError : '') + '</div>';
                                html += '</div>';
                                html += '<button is="emby-button" type="button" class="raised" onclick="CsfdRatingOverlayConfig.openMatch(\'' + item.ItemId + '\', \'' + (item.Title || '').replace(/'/g, "\\'") + '\')">Match</button>';
                                html += '</div>';
                            });
                        }
                        html += '</div>';
                        document.querySelector('#unmatchedList').innerHTML = html;
                    });
                },

                openMatch: function(itemId, title) {
                    CsfdRatingOverlayConfig.currentMatchItemId = itemId;
                    document.querySelector('#matchItemTitle').textContent = title;
                    document.querySelector('#txtMatchSearch').value = title;
                    document.querySelector('#matchSearchResults').innerHTML = '';
                    document.querySelector('#matchDialog').style.display = 'block';
                    document.querySelector('#unmatchedList').style.display = 'none';
                },

                closeMatch: function() {
                    document.querySelector('#matchDialog').style.display = 'none';
                    document.querySelector('#unmatchedList').style.display = 'block';
                    CsfdRatingOverlayConfig.currentMatchItemId = null;
                },

                searchMatch: function() {
                    var query = document.querySelector('#txtMatchSearch').value;
                    if (!query) return;
                    
                    Dashboard.showLoadingMsg();
                    ApiClient.ajax({
                        type: 'POST',
                        url: ApiClient.getUrl('Plugins/CsfdRatingOverlay/csfd/search'),
                        data: JSON.stringify({ Query: query }),
                        contentType: 'application/json',
                        dataType: 'json'
                    }).then(function (results) {
                        Dashboard.hideLoadingMsg();
                        
                        if (typeof results === 'string') {
                            try { results = JSON.parse(results); } catch(e) {}
                        }
                        
                        if (!Array.isArray(results)) {
                             console.error('Unexpected result format', results);
                             Dashboard.alert('Search returned unexpected format.');
                             return;
                        }

                        var html = '<div class="paperList">';
                        if (results.length === 0) {
                            html += '<div class="listItem">No results found.</div>';
                        } else {
                            results.forEach(function(res) {
                                html += '<div class="listItem" style="display: flex; align-items: center; justify-content: space-between; padding: 0.5em; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.1);" onclick="CsfdRatingOverlayConfig.selectMatch(\'' + res.CsfdId + '\')">';
                                html += '<div>';
                                html += '<div class="listItemBodyText" style="font-weight: bold;">' + res.Title + ' (' + (res.Year || '?') + ')</div>';
                                html += '<div class="listItemBodyText secondary">ID: ' + res.CsfdId + (res.IsSeries ? ' (Series)' : '') + '</div>';
                                html += '</div>';
                                html += '</div>';
                            });
                        }
                        html += '</div>';
                        document.querySelector('#matchSearchResults').innerHTML = html;
                    }, function() {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Search failed.');
                    });
                },

                selectMatch: function(csfdId) {
                    if (!confirm('Link this item to ČSFD ID ' + csfdId + '?')) return;
                    
                    Dashboard.showLoadingMsg();
                    ApiClient.ajax({
                        type: 'POST',
                        url: ApiClient.getUrl('Plugins/CsfdRatingOverlay/csfd/match'),
                        data: JSON.stringify({ ItemId: CsfdRatingOverlayConfig.currentMatchItemId, CsfdId: csfdId }),
                        contentType: 'application/json'
                    }).then(function () {
                        Dashboard.hideLoadingMsg();
                        CsfdRatingOverlayConfig.closeMatch();
                        CsfdRatingOverlayConfig.loadUnmatched();
                        CsfdRatingOverlayConfig.loadStatus();
                    }, function(err) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Match failed: ' + err);
                    });
                }
            };

            document.querySelector('#CsfdRatingOverlayConfigForm').addEventListener('submit', function (e) {
                e.preventDefault();
                CsfdRatingOverlayConfig.saveConfiguration();
                return false;
            });

            document.querySelector('#btnRefreshStatus').addEventListener('click', function () {
                CsfdRatingOverlayConfig.loadStatus();
            });

            document.querySelector('#btnPauseResume').addEventListener('click', function () {
                var btn = this;
                var action = btn.getAttribute('data-action') || 'pause';
                CsfdRatingOverlayConfig.runAction(action);
            });

            document.querySelector('#btnBackfill').addEventListener('click', function () {
                CsfdRatingOverlayConfig.runAction('backfill');
            });
            
            document.querySelector('#btnRetryNotFound').addEventListener('click', function () {
                CsfdRatingOverlayConfig.runAction('retry-notfound');
            });

            document.querySelector('#btnRetryErrors').addEventListener('click', function () {
                CsfdRatingOverlayConfig.runAction('retry-errors');
            });
            
            document.querySelector('#btnResetCache').addEventListener('click', function () {
                if (confirm('Are you sure you want to clear the entire cache? This will force re-fetching of all ratings.')) {
                    CsfdRatingOverlayConfig.runAction('reset-cache');
                }
            });

            document.querySelector('#btnInvalidateClientCache').addEventListener('click', function () {
                if (confirm('This will force all clients to clear their local cache and re-fetch ratings. Continue?')) {
                    var config = CsfdRatingOverlayConfig.pluginConfig;
                    config.ClientCacheVersion = Date.now();
                    ApiClient.updatePluginConfiguration(CsfdRatingOverlayConfig.pluginId, config).then(function (result) {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                        Dashboard.alert('Client cache invalidated.');
                    });
                }
            });

            document.querySelector('#btnLoadUnmatched').addEventListener('click', function () {
                CsfdRatingOverlayConfig.loadUnmatched();
            });

            document.querySelector('#btnMatchCancel').addEventListener('click', function () {
                CsfdRatingOverlayConfig.closeMatch();
            });

            document.querySelector('#btnMatchSearch').addEventListener('click', function () {
                CsfdRatingOverlayConfig.searchMatch();
            });

            document.addEventListener('pageshow', function (e) {
                if (e.target.id === 'CsfdRatingOverlayConfigPage') {
                    CsfdRatingOverlayConfig.loadConfiguration();
                    CsfdRatingOverlayConfig.loadStatus();
                }
            });
        </script>
    </div>
</body>
</html>
