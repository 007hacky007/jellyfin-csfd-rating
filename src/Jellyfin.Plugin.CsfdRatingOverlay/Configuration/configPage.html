<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>ČSFD Rating Overlay</title>
</head>
<body>
    <div id="CsfdConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="CsfdConfigForm">
                    <div class="sectionTitleContainer flex align-items-center">
                        <h2 class="sectionTitle">ČSFD Rating Overlay</h2>
                    </div>
                    <div class="verticalSection">
                        <p>Configure ČSFD fetching, retries, cache actions, and optional web overlay injection.</p>
                    </div>

                    <div class="inputContainer">
                        <label class="emby-checkbox-label">
                            <input is="emby-checkbox" type="checkbox" id="chkEnabled" />
                            <span>Enable plugin</span>
                        </label>
                    </div>

                    <div class="inputContainer">
                        <label class="emby-checkbox-label">
                            <input is="emby-checkbox" type="checkbox" id="chkOverlayInjectionEnabled" />
                            <span>Enable web overlay injection</span>
                        </label>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="txtRequestDelayMs">Request delay (ms)</label>
                        <input is="emby-input" type="number" id="txtRequestDelayMs" min="500" step="100" required />
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="txtMaxRetries">Max retries</label>
                        <input is="emby-input" type="number" id="txtMaxRetries" min="1" step="1" required />
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="txtCooldownMinMinutes">Cooldown minimum (minutes)</label>
                        <input is="emby-input" type="number" id="txtCooldownMinMinutes" min="1" step="1" required />
                    </div>

                    <div class="formButtons">
                        <button is="emby-button" type="submit" class="raised button-submit block"><span>${Save}</span></button>
                        <button is="emby-button" type="button" class="raised block" id="btnResetDefaults"><span>Reset to defaults</span></button>
                    </div>

                    <div class="formButtons" style="margin-top:16px;">
                        <button is="emby-button" type="button" class="raised block" id="backfillButton"><span>Backfill library</span></button>
                        <button is="emby-button" type="button" class="raised block" id="retryNotFoundButton"><span>Retry unmatched items</span></button>
                        <button is="emby-button" type="button" class="raised block" id="clearCacheButton"><span>Reset cache</span></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        const CsfdConfig = {
            pluginId: 'b9643a4b-5b92-4f09-94c4-45ce6bfc57e9',
            defaults: {
                Enabled: true,
                OverlayInjectionEnabled: true,
                RequestDelayMs: 2000,
                MaxRetries: 5,
                CooldownMinMinutes: 10
            },
            setFields(config) {
                document.querySelector('#chkEnabled').checked = config.Enabled ?? this.defaults.Enabled;
                document.querySelector('#chkOverlayInjectionEnabled').checked = config.OverlayInjectionEnabled ?? this.defaults.OverlayInjectionEnabled;
                document.querySelector('#txtRequestDelayMs').value = config.RequestDelayMs ?? this.defaults.RequestDelayMs;
                document.querySelector('#txtMaxRetries').value = config.MaxRetries ?? this.defaults.MaxRetries;
                document.querySelector('#txtCooldownMinMinutes').value = config.CooldownMinMinutes ?? this.defaults.CooldownMinMinutes;
            },
            applyForm(config) {
                config.Enabled = document.querySelector('#chkEnabled').checked;
                config.OverlayInjectionEnabled = document.querySelector('#chkOverlayInjectionEnabled').checked;
                config.RequestDelayMs = parseInt(document.querySelector('#txtRequestDelayMs').value, 10) || this.defaults.RequestDelayMs;
                config.MaxRetries = parseInt(document.querySelector('#txtMaxRetries').value, 10) || this.defaults.MaxRetries;
                config.CooldownMinMinutes = parseInt(document.querySelector('#txtCooldownMinMinutes').value, 10) || this.defaults.CooldownMinMinutes;
                return config;
            }
        };

        document.querySelector('#CsfdConfigPage')
            .addEventListener('pageshow', function () {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(CsfdConfig.pluginId).then(config => {
                    CsfdConfig.setFields(config);
                    Dashboard.hideLoadingMsg();
                }, () => Dashboard.hideLoadingMsg());
            });

        document.querySelector('#CsfdConfigForm')
            .addEventListener('submit', function (e) {
                e.preventDefault();
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(CsfdConfig.pluginId).then(config => {
                    return ApiClient.updatePluginConfiguration(CsfdConfig.pluginId, CsfdConfig.applyForm(config));
                }).then(result => {
                    Dashboard.processPluginConfigurationUpdateResult(result);
                }).finally(() => Dashboard.hideLoadingMsg());

                return false;
            });

        document.querySelector('#btnResetDefaults')
            .addEventListener('click', function () {
                CsfdConfig.setFields(CsfdConfig.defaults);
            });

        function wireAction(selector, path) {
            const button = document.querySelector(selector);
            if (!button) {
                return;
            }

            button.addEventListener('click', function () {
                Dashboard.showLoadingMsg();
                ApiClient.ajax({
                    type: 'POST',
                    url: ApiClient.getUrl(`Plugins/CsfdRatingOverlay/${path}`),
                    dataType: 'json'
                }).finally(() => Dashboard.hideLoadingMsg());
            });
        }

        wireAction('#backfillButton', 'csfd/actions/backfill');
        wireAction('#retryNotFoundButton', 'csfd/actions/retry-notfound');
        wireAction('#clearCacheButton', 'csfd/actions/reset-cache');
    </script>
</body>
</html>
